<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Health Dashboard - AI Health Navigator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="style.css">
  <style>
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    .chart-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      min-height: 300px;
    }
    .chart-card h3 {
      margin-top: 0;
      color: #1976d2;
      font-size: 18px;
    }
    .chart-container {
      position: relative;
      height: 250px;
      margin-top: 15px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .stat-card {
      background: linear-gradient(135deg, #1976d2, #42a5f5);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .stat-card h4 {
      margin: 0 0 10px 0;
      font-size: 14px;
      opacity: 0.9;
    }
    .stat-card .stat-value {
      font-size: 32px;
      font-weight: 700;
      margin: 0;
    }
    .no-data {
      text-align: center;
      padding: 40px;
      color: #999;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <h1 class="logo"><span class="material-icons">medical_services</span> AI Health Navigator</h1>
      <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="symptom-checker.html">Symptom Checker</a>
        <a href="symptom-sketch.html">Image Analysis</a>
        <a href="voice-analysis.html">Voice Analysis</a>
        <a href="calendar.html">Health Calendar</a>
        <a href="campus-map.html">Campus Map</a>
        <a href="health-todo.html">Mini-Doc</a>
        <a href="dashboard.html" class="active">Dashboard</a>
        <button id="logoutBtn" class="logout-btn">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <h2><span class="material-icons">bar_chart</span> Health Analytics Dashboard</h2>
      <p>View all your health data and insights in one place</p>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <h4>Total Symptom Checks</h4>
        <p class="stat-value" id="totalSymptoms">0</p>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #43a047, #66bb6a);">
        <h4>Total Sketches</h4>
        <p class="stat-value" id="totalSketches">0</p>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #f57c00, #ff9800);">
        <h4>Voice Analyses</h4>
        <p class="stat-value" id="totalVoice">0</p>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #7b1fa2, #9c27b0);">
        <h4>Total Sessions</h4>
        <p class="stat-value" id="totalSessions">0</p>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #00897b, #26a69a);">
        <h4>Calendar Events</h4>
        <p class="stat-value" id="totalCalendarEvents">0</p>
      </div>
    </div>

    <div class="dashboard-grid">
      <div class="chart-card">
        <h3><span class="material-icons">mic</span> Voice Stress Trend</h3>
        <div class="chart-container">
          <canvas id="voiceStressChart"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <h3><span class="material-icons">bar_chart</span> Symptom Check Frequency</h3>
        <div class="chart-container">
          <canvas id="symptomFrequencyChart"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <h3><span class="material-icons">brush</span> Symptom Image Analysis Activity</h3>
        <div class="chart-container">
          <canvas id="sketchActivityChart"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <h3><span class="material-icons">trending_up</span> Overall Activity Timeline</h3>
        <div class="chart-container">
          <canvas id="activityTimelineChart"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <h3><span class="material-icons">calendar_today</span> Health Calendar Events (Last 30 Days)</h3>
        <div class="chart-container">
          <canvas id="calendarEventsChart"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <h3><span class="material-icons">local_hospital</span> Clinic Visits Over Time</h3>
        <div class="chart-container">
          <canvas id="clinicVisitsChart"></canvas>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top: 30px;">
      <h3>üìä Health Condition Analysis</h3>
      <div style="margin-bottom: 20px;">
        <button class="tab-btn active" data-period="week" onclick="analyzeHealthPeriod('week')">Last Week</button>
        <button class="tab-btn" data-period="month" onclick="analyzeHealthPeriod('month')">Last Month</button>
        <button class="tab-btn" data-period="year" onclick="analyzeHealthPeriod('year')">Last Year</button>
      </div>
      <div id="healthAnalysis" class="no-data">Select a time period to view health analysis</div>
    </div>

    <div class="card" style="margin-top: 30px;">
      <h3>Recent Activity</h3>
      <div id="recentActivity" class="no-data">Loading recent activity...</div>
    </div>
  </div>

  <script src="auth.js"></script>
  <script src="chatbot.js"></script>
  <script src="notifications.js"></script>
  <script src="mobile-nav.js"></script>
  <script src="toast.js"></script>
  <script src="skeleton-loaders.js"></script>
  <script>
    // Require authentication
    requireAuth().then(user => {
      console.log("User authenticated:", user.uid);
      
      // Wait for all scripts to load before showing skeletons
      if (typeof SkeletonLoader !== 'undefined' && typeof toast !== 'undefined') {
        // Show skeleton loaders
        showDashboardSkeletons();
        
        // Load dashboard with delay for better UX
        setTimeout(() => {
          loadDashboard(user.uid);
        }, 500);
      } else {
        // Fallback if scripts haven't loaded
        console.warn('SkeletonLoader or toast not available, loading dashboard without skeletons');
        loadDashboard(user.uid);
      }
    }).catch(error => {
      console.error('Authentication error:', error);
      window.location.href = 'login.html';
    });

    // Show skeleton loaders
    function showDashboardSkeletons() {
      if (typeof SkeletonLoader === 'undefined') {
        console.warn('SkeletonLoader not available');
        return;
      }

      try {
        const statsGrid = document.querySelector('.stats-grid');
        if (statsGrid) {
          SkeletonLoader.show(statsGrid, 'stats-grid', 5);
        }

        const dashboardGrid = document.querySelector('.dashboard-grid');
        if (dashboardGrid) {
          SkeletonLoader.show(dashboardGrid, 'charts-grid', 6);
        }

        const recentActivity = document.getElementById('recentActivity');
        if (recentActivity) {
          const skeleton = document.createElement('div');
          for (let i = 0; i < 5; i++) {
            // Clone the skeleton item for each iteration
            const listItem = SkeletonLoader.createListItem();
            skeleton.appendChild(listItem.cloneNode(true));
          }
          recentActivity.innerHTML = '';
          recentActivity.appendChild(skeleton);
        }

        const healthAnalysis = document.getElementById('healthAnalysis');
        if (healthAnalysis) {
          const paragraphSkeleton = SkeletonLoader.createParagraph(4);
          healthAnalysis.innerHTML = '';
          healthAnalysis.appendChild(paragraphSkeleton);
        }
      } catch (error) {
        console.error('Error showing skeleton loaders:', error);
      }
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await auth.signOut();
      window.location.href = 'login.html';
    });

    async function loadDashboard(uid) {
      try {
        // Show loading toast
        if (typeof toast !== 'undefined') {
          toast.info('Loading your health dashboard...', 'Loading', 2000);
        }

        // Load all data (without orderBy to avoid index requirements, we'll sort in code)
        const [symptomLogs, sketchLogs, voiceLogs, calendarEvents] = await Promise.all([
          db.collection("symptom_logs").where("userId", "==", uid).get(),
          db.collection("sketch_logs").where("userId", "==", uid).get(),
          db.collection("voiceStressLogs").where("userId", "==", uid).get(),
          db.collection("health_calendar").where("userId", "==", uid).get()
        ]);

        // Hide skeleton loaders - restore original content by setting innerHTML manually
        const statsGrid = document.querySelector('.stats-grid');
        if (statsGrid) {
          // Clear skeleton and restore stats cards
          statsGrid.innerHTML = `
            <div class="stat-card">
              <h4>Total Symptom Checks</h4>
              <p class="stat-value" id="totalSymptoms">0</p>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #43a047, #66bb6a);">
              <h4>Total Sketches</h4>
              <p class="stat-value" id="totalSketches">0</p>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f57c00, #ff9800);">
              <h4>Voice Analyses</h4>
              <p class="stat-value" id="totalVoice">0</p>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #7b1fa2, #9c27b0);">
              <h4>Total Sessions</h4>
              <p class="stat-value" id="totalSessions">0</p>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #00897b, #26a69a);">
              <h4>Calendar Events</h4>
              <p class="stat-value" id="totalCalendarEvents">0</p>
            </div>
          `;
        }

        const dashboardGrid = document.querySelector('.dashboard-grid');
        if (dashboardGrid && dashboardGrid.querySelector('.chart-skeleton')) {
          // Clear skeleton and restore chart cards
          dashboardGrid.innerHTML = `
            <div class="chart-card">
              <h3><span class="material-icons">mic</span> Voice Stress Trend</h3>
              <div class="chart-container">
                <canvas id="voiceStressChart"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <h3><span class="material-icons">bar_chart</span> Symptom Check Frequency</h3>
              <div class="chart-container">
                <canvas id="symptomFrequencyChart"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <h3><span class="material-icons">brush</span> Symptom Image Analysis Activity</h3>
              <div class="chart-container">
                <canvas id="sketchActivityChart"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <h3><span class="material-icons">trending_up</span> Overall Activity Timeline</h3>
              <div class="chart-container">
                <canvas id="activityTimelineChart"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <h3><span class="material-icons">calendar_today</span> Health Calendar Events (Last 30 Days)</h3>
              <div class="chart-container">
                <canvas id="calendarEventsChart"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <h3><span class="material-icons">local_hospital</span> Clinic Visits Over Time</h3>
              <div class="chart-container">
                <canvas id="clinicVisitsChart"></canvas>
              </div>
            </div>
          `;
        }

        // Sort in JavaScript to avoid Firestore index requirements
        const sortByDate = (a, b, dateField) => {
          const dateA = a.data()[dateField]?.toDate?.() || new Date(a.data()[dateField] || 0);
          const dateB = b.data()[dateField]?.toDate?.() || new Date(b.data()[dateField] || 0);
          return dateB - dateA; // Descending order
        };

        // Sort each collection
        const sortedSymptomLogs = symptomLogs.docs.sort((a, b) => sortByDate(a, b, 'createdAt'));
        const sortedSketchLogs = sketchLogs.docs.sort((a, b) => sortByDate(a, b, 'createdAt'));
        const sortedVoiceLogs = voiceLogs.docs.sort((a, b) => sortByDate(a, b, 'timestamp'));
        const sortedCalendarEvents = calendarEvents.docs.sort((a, b) => {
          const dateA = new Date(a.data().date || 0);
          const dateB = new Date(b.data().date || 0);
          return dateB - dateA;
        });

        // Create mock QuerySnapshot-like objects for compatibility
        const mockQuerySnapshot = (docs) => ({
          docs: docs,
          size: docs.length,
          forEach: (callback) => docs.forEach(callback)
        });

        const symptomLogsSorted = mockQuerySnapshot(sortedSymptomLogs);
        const sketchLogsSorted = mockQuerySnapshot(sortedSketchLogs);
        const voiceLogsSorted = mockQuerySnapshot(sortedVoiceLogs);
        const calendarEventsSorted = mockQuerySnapshot(sortedCalendarEvents);

        // Update stats (use sorted collections) - ensure elements exist
        const totalSymptomsEl = document.getElementById('totalSymptoms');
        const totalSketchesEl = document.getElementById('totalSketches');
        const totalVoiceEl = document.getElementById('totalVoice');
        const totalSessionsEl = document.getElementById('totalSessions');
        const totalCalendarEventsEl = document.getElementById('totalCalendarEvents');
        
        if (totalSymptomsEl) totalSymptomsEl.textContent = symptomLogsSorted.size;
        if (totalSketchesEl) totalSketchesEl.textContent = sketchLogsSorted.size;
        if (totalVoiceEl) totalVoiceEl.textContent = voiceLogsSorted.size;
        if (totalSessionsEl) totalSessionsEl.textContent = symptomLogsSorted.size + sketchLogsSorted.size + voiceLogsSorted.size;
        if (totalCalendarEventsEl) totalCalendarEventsEl.textContent = calendarEventsSorted.size;

        // Voice Stress Chart
        const voiceData = [];
        const voiceLabels = [];
        voiceLogsSorted.forEach(doc => {
          const d = doc.data();
          const date = d.timestamp?.toDate();
          if (date) {
            voiceLabels.push(date.toLocaleDateString());
            const result = d.aiResult || '';
            if (result.includes('High Stress') || result.includes('High')) {
              voiceData.push(3);
            } else if (result.includes('Moderate Stress') || result.includes('Moderate')) {
              voiceData.push(2);
            } else {
              voiceData.push(1);
            }
          }
        });

        const voiceStressCanvas = document.getElementById('voiceStressChart');
        if (voiceData.length > 0 && voiceStressCanvas) {
          new Chart(voiceStressCanvas, {
            type: 'line',
            data: {
              labels: voiceLabels.slice(0, 10).reverse(),
              datasets: [{
                label: 'Stress Level',
                data: voiceData.slice(0, 10).reverse(),
                borderColor: '#d32f2f',
                backgroundColor: 'rgba(211, 47, 47, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  max: 3,
                  ticks: {
                    stepSize: 1,
                    callback: function(value) {
                      if (value === 1) return 'Calm';
                      if (value === 2) return 'Moderate';
                      if (value === 3) return 'High';
                      return '';
                    }
                  }
                }
              }
            }
          });
        } else {
          const voiceStressContainer = document.getElementById('voiceStressChart');
          if (voiceStressContainer && voiceStressContainer.parentElement) {
            voiceStressContainer.parentElement.innerHTML = createEmptyState(
              'chart',
              'No Voice Analysis Data',
              'Complete voice stress analysis to see your trends here.',
              [{ text: 'Try Voice Analysis', href: 'voice-analysis.html' }]
            );
          }
        }

        // Symptom Frequency Chart
        const symptomDates = {};
        symptomLogsSorted.forEach(doc => {
          const d = doc.data();
          const date = d.createdAt?.toDate();
          if (date) {
            const dateStr = date.toLocaleDateString();
            symptomDates[dateStr] = (symptomDates[dateStr] || 0) + 1;
          }
        });

        const symptomFreqCanvas = document.getElementById('symptomFrequencyChart');
        if (Object.keys(symptomDates).length > 0 && symptomFreqCanvas) {
          new Chart(symptomFreqCanvas, {
            type: 'bar',
            data: {
              labels: Object.keys(symptomDates).slice(-7),
              datasets: [{
                label: 'Symptom Checks',
                data: Object.keys(symptomDates).slice(-7).map(d => symptomDates[d]),
                backgroundColor: '#1976d2'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false
            }
          });
        } else {
          const symptomFreqContainer = document.getElementById('symptomFrequencyChart');
          if (symptomFreqContainer && symptomFreqContainer.parentElement) {
            symptomFreqContainer.parentElement.innerHTML = createEmptyState(
              'chart',
              'No Symptom Check Data',
              'Start tracking your symptoms to see patterns over time.',
              [{ text: 'Check Symptoms', href: 'symptom-checker.html' }]
            );
          }
        }

        // Sketch Activity Chart
        const sketchDates = {};
        sketchLogsSorted.forEach(doc => {
          const d = doc.data();
          const date = d.createdAt?.toDate();
          if (date) {
            const dateStr = date.toLocaleDateString();
            sketchDates[dateStr] = (sketchDates[dateStr] || 0) + 1;
          }
        });

        const sketchActivityCanvas = document.getElementById('sketchActivityChart');
        if (Object.keys(sketchDates).length > 0 && sketchActivityCanvas) {
          new Chart(sketchActivityCanvas, {
            type: 'doughnut',
            data: {
              labels: Object.keys(sketchDates),
              datasets: [{
                data: Object.values(sketchDates),
                backgroundColor: [
                  '#43a047',
                  '#66bb6a',
                  '#81c784',
                  '#a5d6a7'
                ]
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false
            }
          });
        } else {
          const sketchActivityContainer = document.getElementById('sketchActivityChart');
          if (sketchActivityContainer && sketchActivityContainer.parentElement) {
            sketchActivityContainer.parentElement.innerHTML = createEmptyState(
              'chart',
              'No Image Analysis Data',
              'Use image analysis feature to see your activity here.',
              [{ text: 'Try Image Analysis', href: 'symptom-sketch.html' }]
            );
          }
        }

        // Activity Timeline
        const allActivities = [];
        symptomLogsSorted.forEach(doc => {
          const d = doc.data();
          const date = d.createdAt?.toDate();
          if (date) {
            allActivities.push({ date, type: 'Symptom Check' });
          }
        });
        sketchLogsSorted.forEach(doc => {
          const d = doc.data();
          const date = d.createdAt?.toDate();
          if (date) {
            allActivities.push({ date, type: 'Image Analysis' });
          }
        });
        voiceLogsSorted.forEach(doc => {
          const d = doc.data();
          const date = d.timestamp?.toDate();
          if (date) {
            allActivities.push({ date, type: 'Voice Analysis' });
          }
        });

        allActivities.sort((a, b) => b.date - a.date);

        if (allActivities.length > 0) {
          const timelineData = {};
          allActivities.slice(0, 7).forEach(act => {
            const dateStr = act.date.toLocaleDateString();
            if (!timelineData[dateStr]) {
              timelineData[dateStr] = { 'Symptom Check': 0, 'Sketch': 0, 'Voice Analysis': 0 };
            }
            timelineData[dateStr][act.type]++;
          });

          const dates = Object.keys(timelineData).reverse();
          const activityTimelineCanvas = document.getElementById('activityTimelineChart');
          if (activityTimelineCanvas) {
            new Chart(activityTimelineCanvas, {
            type: 'bar',
            data: {
              labels: dates,
              datasets: [
                {
                  label: 'Symptom Checks',
                  data: dates.map(d => timelineData[d]['Symptom Check']),
                  backgroundColor: '#1976d2'
                },
                {
                  label: 'Image Analyses',
                  data: dates.map(d => timelineData[d]['Images Analyzed']),
                  backgroundColor: '#43a047'
                },
                {
                  label: 'Voice Analyses',
                  data: dates.map(d => timelineData[d]['Voice Analysis']),
                  backgroundColor: '#f57c00'
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  stacked: true
                },
                y: {
                  stacked: true
                }
              }
            }
            });
          }
        } else {
          const activityTimelineContainer = document.getElementById('activityTimelineChart');
          if (activityTimelineContainer && activityTimelineContainer.parentElement) {
            activityTimelineContainer.parentElement.innerHTML = createEmptyState(
              'chart',
              'No Activity Timeline',
              'Use any health feature to start building your activity timeline.',
              [{ text: 'Explore Features', href: 'index.html' }]
            );
          }
        }

        // Recent Activity
        const recentActivityEl = document.getElementById('recentActivity');
        if (allActivities.length > 0) {
          const activityList = document.createElement('ul');
          activityList.style.listStyle = 'none';
          activityList.style.padding = '0';
          activityList.className = 'animate-stagger';
          
          allActivities.slice(0, 10).forEach((act, index) => {
            const iconName = act.type === 'Symptom Check' ? 'medical_services' : act.type === 'Sketch' ? 'brush' : 'mic';
            const li = document.createElement('li');
            li.style.cssText = 'padding: 16px; margin: 8px 0; background: white; border-radius: 12px; border-left: 4px solid #1976d2; display:flex; gap:12px; align-items:center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s;';
            li.innerHTML = `
              <span class="material-icons" style="color:#1976d2; font-size:24px;">${iconName}</span>
              <div style="flex:1;">
                <strong style="display:block; margin-bottom:4px; color:#333;">${act.type}</strong>
                <span style="font-size:13px; color:#666;">${act.date.toLocaleString()}</span>
              </div>
            `;
            li.addEventListener('mouseenter', () => {
              li.style.transform = 'translateX(4px)';
              li.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
            });
            li.addEventListener('mouseleave', () => {
              li.style.transform = 'translateX(0)';
              li.style.boxShadow = '0 2px 8px rgba(0,0,0,0.05)';
            });
            activityList.appendChild(li);
          });
          
          recentActivityEl.innerHTML = '';
          recentActivityEl.appendChild(activityList);
        } else {
          recentActivityEl.innerHTML = createEmptyState(
            'history',
            'No Recent Activity',
            'Start using the health tools to see your activity history here!',
            [{ text: 'Try Symptom Checker', href: 'symptom-checker.html' }, { text: 'View Features', href: 'index.html' }]
          );
        }

        // Calendar Events Chart (Last 30 Days)
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        const recentEvents = calendarEventsSorted.docs.filter(doc => {
          const eventDate = new Date(doc.data().date);
          return eventDate >= thirtyDaysAgo;
        });

        const eventTypeCount = { clinic: 0, medication: 0, symptom: 0, other: 0 };
        recentEvents.forEach(doc => {
          const type = doc.data().type;
          if (eventTypeCount.hasOwnProperty(type)) {
            eventTypeCount[type]++;
          }
        });

        const calendarEventsCanvas = document.getElementById('calendarEventsChart');
        if (Object.values(eventTypeCount).some(v => v > 0) && calendarEventsCanvas) {
          new Chart(calendarEventsCanvas, {
            type: 'doughnut',
            data: {
              labels: ['Clinic Visits', 'Medications', 'Symptoms', 'Other Notes'],
              datasets: [{
                data: [
                  eventTypeCount.clinic,
                  eventTypeCount.medication,
                  eventTypeCount.symptom,
                  eventTypeCount.other
                ],
                backgroundColor: ['#d32f2f', '#43a047', '#ff9800', '#1976d2']
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false
            }
          });
        } else {
          const calendarEventsContainer = document.getElementById('calendarEventsChart');
          if (calendarEventsContainer && calendarEventsContainer.parentElement) {
            calendarEventsContainer.parentElement.innerHTML = createEmptyState(
              'calendar',
              'No Calendar Events',
              'Add events to your health calendar to track clinic visits and medications.',
              [{ text: 'Open Calendar', href: 'calendar.html' }]
            );
          }
        }

        // Clinic Visits Over Time
        const clinicVisits = calendarEventsSorted.docs
          .filter(doc => doc.data().type === 'clinic')
          .map(doc => {
            const data = doc.data();
            return {
              date: new Date(data.date),
              title: data.title
            };
          })
          .sort((a, b) => a.date - b.date);

        const clinicVisitsCanvas = document.getElementById('clinicVisitsChart');
        if (clinicVisits.length > 0 && clinicVisitsCanvas) {
          const visitsByMonth = {};
          clinicVisits.forEach(visit => {
            const monthKey = visit.date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
            visitsByMonth[monthKey] = (visitsByMonth[monthKey] || 0) + 1;
          });

          new Chart(clinicVisitsCanvas, {
            type: 'line',
            data: {
              labels: Object.keys(visitsByMonth),
              datasets: [{
                label: 'Clinic Visits',
                data: Object.values(visitsByMonth),
                borderColor: '#d32f2f',
                backgroundColor: 'rgba(211, 47, 47, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false
            }
          });
        } else {
          const clinicVisitsContainer = document.getElementById('clinicVisitsChart');
          if (clinicVisitsContainer && clinicVisitsContainer.parentElement) {
            clinicVisitsContainer.parentElement.innerHTML = createEmptyState(
              'calendar',
              'No Clinic Visits',
              'Record your clinic visits in the calendar to track them here.',
              [{ text: 'Add Calendar Event', href: 'calendar.html' }]
            );
          }
        }

        // Store calendar events for health analysis
        window.calendarEventsData = calendarEventsSorted.docs.map(doc => doc.data());
        window.symptomLogsData = symptomLogsSorted.docs.map(doc => doc.data());
        window.voiceLogsData = voiceLogsSorted.docs.map(doc => doc.data());

        // Show success toast
        if (typeof toast !== 'undefined') {
          toast.success('Dashboard loaded successfully!', 'Success', 3000);
        }

      } catch (error) {
        console.error('Dashboard load error:', error);
        
        // Hide skeleton loaders on error - restore original content
        const statsGrid = document.querySelector('.stats-grid');
        if (statsGrid && statsGrid.querySelector('.dashboard-skeleton')) {
          statsGrid.innerHTML = `
            <div class="stat-card">
              <h4>Total Symptom Checks</h4>
              <p class="stat-value" id="totalSymptoms">0</p>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #43a047, #66bb6a);">
              <h4>Total Sketches</h4>
              <p class="stat-value" id="totalSketches">0</p>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f57c00, #ff9800);">
              <h4>Voice Analyses</h4>
              <p class="stat-value" id="totalVoice">0</p>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #7b1fa2, #9c27b0);">
              <h4>Total Sessions</h4>
              <p class="stat-value" id="totalSessions">0</p>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #00897b, #26a69a);">
              <h4>Calendar Events</h4>
              <p class="stat-value" id="totalCalendarEvents">0</p>
            </div>
          `;
        }
        
        const dashboardGrid = document.querySelector('.dashboard-grid');
        if (dashboardGrid && dashboardGrid.querySelector('.chart-skeleton')) {
          dashboardGrid.innerHTML = `
            <div class="chart-card">
              <h3><span class="material-icons">mic</span> Voice Stress Trend</h3>
              <div class="chart-container">
                <canvas id="voiceStressChart"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <h3><span class="material-icons">bar_chart</span> Symptom Check Frequency</h3>
              <div class="chart-container">
                <canvas id="symptomFrequencyChart"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <h3><span class="material-icons">brush</span> Symptom Image Analysis Activity</h3>
              <div class="chart-container">
                <canvas id="sketchActivityChart"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <h3><span class="material-icons">trending_up</span> Overall Activity Timeline</h3>
              <div class="chart-container">
                <canvas id="activityTimelineChart"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <h3><span class="material-icons">calendar_today</span> Health Calendar Events (Last 30 Days)</h3>
              <div class="chart-container">
                <canvas id="calendarEventsChart"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <h3><span class="material-icons">local_hospital</span> Clinic Visits Over Time</h3>
              <div class="chart-container">
                <canvas id="clinicVisitsChart"></canvas>
              </div>
            </div>
          `;
        }
        
        // Show error state
        const recentActivityEl = document.getElementById('recentActivity');
        if (recentActivityEl) {
          recentActivityEl.innerHTML = createEmptyState(
            'error',
            'Error Loading Dashboard',
            'We couldn\'t load your dashboard. Please try refreshing the page.',
            [{ text: 'Refresh Page', href: 'javascript:window.location.reload()' }]
          );
        }
        
        // Show error toast
        if (typeof toast !== 'undefined') {
          toast.error('Failed to load dashboard. Please refresh the page.', 'Error', 7000);
        } else {
          alert('Error loading data. Please refresh the page.\n' + error.message);
        }
      }
    }

    // Create empty state component
    function createEmptyState(iconName, title, message, actions = []) {
      const icons = {
        'history': 'history',
        'error': 'error_outline',
        'chart': 'bar_chart',
        'calendar': 'calendar_today',
        'default': 'inbox'
      };
      
      const icon = icons[iconName] || icons.default;
      
      // Create container div
      const container = document.createElement('div');
      container.className = 'empty-state animate-fade-in';
      
      // Create icon
      const iconDiv = document.createElement('div');
      iconDiv.className = 'empty-state-icon';
      const iconSpan = document.createElement('span');
      iconSpan.className = 'material-icons';
      iconSpan.style.cssText = 'font-size:80px; opacity:0.5;';
      iconSpan.textContent = icon;
      iconDiv.appendChild(iconSpan);
      container.appendChild(iconDiv);
      
      // Create title
      const titleH3 = document.createElement('h3');
      titleH3.textContent = title;
      container.appendChild(titleH3);
      
      // Create message
      const messageP = document.createElement('p');
      messageP.textContent = message;
      container.appendChild(messageP);
      
      // Create actions if provided
      if (actions && actions.length > 0) {
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'empty-state-actions';
        
        actions.forEach((action, index) => {
          if (action.href) {
            // Check if href is a javascript: protocol or regular URL
            if (action.href.startsWith('javascript:')) {
              const btn = document.createElement('button');
              btn.className = 'empty-state-button';
              btn.textContent = action.text;
              btn.onclick = function() {
                const code = action.href.replace('javascript:', '');
                eval(code);
              };
              actionsDiv.appendChild(btn);
            } else {
              const link = document.createElement('a');
              link.href = action.href;
              link.className = 'empty-state-button';
              link.textContent = action.text;
              actionsDiv.appendChild(link);
            }
          } else if (action.action) {
            // For function actions, create a button with proper event handler
            const btn = document.createElement('button');
            btn.className = 'empty-state-button';
            btn.textContent = action.text;
            if (typeof action.action === 'function') {
              btn.addEventListener('click', action.action);
            }
            actionsDiv.appendChild(btn);
          } else {
            const btn = document.createElement('button');
            btn.className = 'empty-state-button secondary';
            btn.textContent = action.text;
            actionsDiv.appendChild(btn);
          }
        });
        
        container.appendChild(actionsDiv);
      }
      
      return container.outerHTML;
    }

    // Health Analysis by Period
    async function analyzeHealthPeriod(period) {
      const analysisEl = document.getElementById('healthAnalysis');
      analysisEl.innerHTML = '<div class="loading-spinner"><span class="material-icons">hourglass_top</span> Analyzing health data...</div>';

      // Update active tab
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.period === period) {
          btn.classList.add('active');
        }
      });

      try {
        const now = new Date();
        let startDate = new Date();
        
        if (period === 'week') {
          startDate.setDate(now.getDate() - 7);
        } else if (period === 'month') {
          startDate.setMonth(now.getMonth() - 1);
        } else if (period === 'year') {
          startDate.setFullYear(now.getFullYear() - 1);
        }

        const calendarEvents = window.calendarEventsData || [];
        const symptomLogs = window.symptomLogsData || [];
        const voiceLogs = window.voiceLogsData || [];

        // Filter data by period
        const periodEvents = calendarEvents.filter(event => {
          const eventDate = new Date(event.date);
          return eventDate >= startDate;
        });

        const periodSymptoms = symptomLogs.filter(log => {
          const logDate = log.createdAt?.toDate() || new Date(log.createdAt);
          return logDate >= startDate;
        });

        const periodVoice = voiceLogs.filter(log => {
          const logDate = log.timestamp?.toDate() || new Date(log.timestamp);
          return logDate >= startDate;
        });

        // Analyze health condition
        let analysis = `<div style="line-height: 1.8;">`;
        analysis += `<h4 style="color: #1976d2; margin-top: 0;">Health Summary (${period === 'week' ? 'Last Week' : period === 'month' ? 'Last Month' : 'Last Year'})</h4>`;
        
        // Calendar events analysis
        if (periodEvents.length > 0) {
          const clinicVisits = periodEvents.filter(e => e.type === 'clinic').length;
          const medications = periodEvents.filter(e => e.type === 'medication').length;
          const symptoms = periodEvents.filter(e => e.type === 'symptom').length;
          
          analysis += `<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">`;
          analysis += `<strong><span class="material-icons">calendar_today</span> Calendar Events:</strong><br>`;
          analysis += `‚Ä¢ Clinic Visits: ${clinicVisits}<br>`;
          analysis += `‚Ä¢ Medications: ${medications}<br>`;
          analysis += `‚Ä¢ Symptoms Recorded: ${symptoms}<br>`;
          analysis += `‚Ä¢ Total Events: ${periodEvents.length}`;
          analysis += `</div>`;
        }

        // Symptom checks analysis
        if (periodSymptoms.length > 0) {
          analysis += `<div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 15px;">`;
          analysis += `<strong><span class="material-icons">medical_services</span> Symptom Checks:</strong> ${periodSymptoms.length} check(s) in this period`;
          analysis += `</div>`;
        }

        // Voice stress analysis
        let highStress = 0, moderateStress = 0, calm = 0;
        if (periodVoice.length > 0) {
          periodVoice.forEach(log => {
            const result = log.aiResult || '';
            if (result.includes('High Stress') || result.includes('High')) {
              highStress++;
            } else if (result.includes('Moderate Stress') || result.includes('Moderate')) {
              moderateStress++;
            } else {
              calm++;
            }
          });

          analysis += `<div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">`;
          analysis += `<strong><span class="material-icons">mic</span> Voice Stress Analysis:</strong><br>`;
          analysis += `‚Ä¢ High Stress: ${highStress}<br>`;
          analysis += `‚Ä¢ Moderate Stress: ${moderateStress}<br>`;
          analysis += `‚Ä¢ Calm: ${calm}`;
          analysis += `</div>`;
        }

        // Overall health assessment
        analysis += `<div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-top: 15px;">`;
        analysis += `<strong><span class="material-icons">lightbulb</span> Health Insights:</strong><br>`;
        
        if (periodEvents.length === 0 && periodSymptoms.length === 0 && periodVoice.length === 0) {
          analysis += `No health data recorded in this period. Start tracking your health to get insights!`;
        } else {
          const totalActivities = periodEvents.length + periodSymptoms.length + periodVoice.length;
          analysis += `‚Ä¢ Total health activities: ${totalActivities}<br>`;
          
          if (periodEvents.filter(e => e.type === 'clinic').length > 0) {
            analysis += `‚Ä¢ You've been proactive about clinic visits. Keep it up!<br>`;
          }
          
          if (periodVoice.length > 0) {
            const avgStress = (highStress * 3 + moderateStress * 2 + calm * 1) / periodVoice.length;
            if (avgStress > 2) {
              analysis += `‚Ä¢ Consider stress management techniques and self-care.<br>`;
            } else {
              analysis += `‚Ä¢ Your stress levels appear manageable. Great job!<br>`;
            }
          }
          
          analysis += `‚Ä¢ Continue tracking your health for better insights over time.`;
        }
        
        analysis += `</div>`;
        analysis += `</div>`;

        analysisEl.innerHTML = analysis;

      } catch (error) {
        analysisEl.innerHTML = '<div class="error-message">‚ùå Error analyzing health data. Please try again.<br><small>' + error.message + '</small></div>';
      }
    }
  </script>
</body>
</html>
